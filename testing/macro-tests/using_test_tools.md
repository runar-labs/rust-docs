# Using Macro Testing Tools

This guide covers how to use the tools provided in the `rust-macros-tests` crate for testing procedural macros.

## Prerequisites

1. Install `cargo-expand`:
   ```bash
   cargo install cargo-expand
   ```

2. Ensure you're using a nightly compiler (required for `cargo-expand`):
   ```bash
   rustup override set nightly
   # Or just for the current command:
   # rustup run nightly cargo expand ...
   ```

## Testing All Macros

The `check_expansions.sh` script tests all macros defined in the examples directory:

```bash
cd rust-macros-tests
./tools/check_expansions.sh
```

This will:
1. Expand each example file using `cargo-expand`
2. Save the output to the `expansion_outputs` directory
3. Report success or failure for each expansion

## Testing Specific Macros

To test a specific macro, use the `check_specific_macro.sh` script:

```bash
cd rust-macros-tests
./tools/check_specific_macro.sh service_macro   # Test the service macro
./tools/check_specific_macro.sh action_macro    # Test the action macro
./tools/check_specific_macro.sh event_macros    # Test event-related macros
```

This will:
1. Expand only the specified example file
2. Save the output to the `expansion_outputs` directory
3. Show a summary of the expansion in the terminal

## Understanding the Output

The expanded output shows the actual code generated by the macros. Key things to look for:

1. **Service Macro**: Check for:
   - Trait implementations (`ServiceInfo`, etc.)
   - Registration code
   - Proper attribute handling

2. **Action Macro**: Check for:
   - Handler registration
   - Parameter extraction code
   - Response formatting
   - Error handling

3. **Subscribe Macro**: Check for:
   - Subscription registration
   - Event handling code
   - Parameter deserialization

## Example Analysis

Here's an example analysis of a service macro expansion:

```rust
// Original code with macro
#[service(
    name = "example",
    description = "An example service",
    version = "1.0.0"
)]
struct ExampleService { ... }

// Expansion might include:
impl ServiceInfo for ExampleService {
    fn name(&self) -> &str {
        "example"
    }
    
    fn description(&self) -> &str {
        "An example service"
    }
    
    fn version(&self) -> &str {
        "1.0.0"
    }
}

// And registration code:
inventory::submit! {
    ServiceRegistration::new::<ExampleService>("example")
}
```

## Troubleshooting

### Common Issues

1. **Expansion fails with error**:
   - Check that you're using a nightly compiler
   - Ensure all dependencies are available
   - Verify the example code is properly written

2. **Empty expansion output**:
   - The macro might not be generating any code
   - The feature flag might not be properly enabled

3. **Unexpected expansion**:
   - The macro implementation might have changed
   - Dependencies might have been updated

### Debugging Tips

1. Set the `RUSTFLAGS="-Z macro-backtrace"` environment variable to get more detailed macro expansion errors:
   ```bash
   RUSTFLAGS="-Z macro-backtrace" ./tools/check_specific_macro.sh service_macro
   ```

2. Check the `Cargo.toml` for proper feature configuration:
   ```toml
   [features]
   full_test = [
       "runar_node",
       "runar_common",
       # ...other dependencies
   ]
   ```

3. If a specific macro is failing, examine its implementation in the `rust-macros` crate.

## Available Examples

The following examples are available in the `src/examples/` directory:

### Service Macro (`service_macro.rs`)

Demonstrates the `#[service]` macro which:
- Registers a service with the global registry
- Implements `AbstractService` for your struct
- Sets up service metadata

### Action Macro (`action_macro.rs`)

Demonstrates the `#[action]` macro which:
- Registers action handlers for a service
- Sets up parameter extraction
- Implements request handling

### Event Macros (`event_macros.rs`)

Demonstrates the `#[subscribe]` and `#[publish]` macros which:
- Register event subscribers
- Set up event publication methods
- Implement event handling

## Custom Testing

You can also create your own test files to verify specific macro behaviors:

1. Create a new file in the `src/examples/` directory
2. Add your test code using the macros you want to test
3. Run `cargo expand --package runar-macros-tests --features=full_test --file src/examples/your_file.rs`

## Integration with Documentation

The testing tools are integrated with the documentation system. You can find more detailed information about the macro testing approach in the `rust-docs/testing/macro_testing_approach.md` file. 