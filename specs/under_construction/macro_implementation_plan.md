# Macro Implementation Plan: Fresh Approach

## Progress Update

### Completed Tasks:
- âœ… Phase 1: Reference Implementation
  - âœ… Created reference implementation (StringService) that demonstrates service structure
  - âœ… Implemented complete working service with actions
  - âœ… Fixed all issues with StringService implementation (handling Option<ValueType> data)
  - âœ… Successfully tested with Node API
  - âœ… Removed duplicate code from docs directory
  - âœ… Identified critical issue with event handling in subscribe callbacks
- âœ… Core System Fixes
  - âœ… Fixed the Node API event handling system (event_handling_core_fix.md now in completed folder)
  - âœ… Implemented async-only callbacks for subscriptions
  - âœ… Updated ServiceRegistry to properly handle async callbacks
  - âœ… Updated RequestContext to support the new async subscription API
- âœ… Macro Implementation Foundations
  - âœ… Initial service macro implementation that generates AbstractService implementation
  - âœ… Initial action macro implementation for registering action handlers
  - âœ… Initial subscribe macro implementation with async event callbacks
- âœ… Macro Refinements
  - âœ… Enhanced service macro to add ActionRegistry field and register_actions method
  - âœ… Added parameter extraction logic to action handlers for both direct and map-based parameters
  - âœ… Improved subscribe macro to handle different payload formats (direct values, maps)
  - âœ… Added proper error handling for parameter extraction
  - âœ… Verified that the reference implementation test passes with current code

### Tasks In Progress:
- ðŸ”„ Auto-Registration System
  - ðŸ”„ Designing a system to connect individual registration methods
  - ðŸ”„ Implementing a macro registry to track all actions and subscriptions
  - ðŸ”„ Modifying the service macro to call all individual registration methods

### Tasks To Do:
- â¬œ Testing
  - â¬œ Create new macro test implementation using the enhanced macros
  - â¬œ Ensure macros produce exactly the same code as the manually written version
  - â¬œ Create comprehensive tests that verify macro behavior

- â¬œ Test Development
  - â¬œ Create new tests that verify macro behavior, not implementation details
  - â¬œ Focus on end-to-end testing with the Node API
  - â¬œ Demonstrate how services should be used in real-world scenarios

## ~~New Issue: Event Handler Limitations in Core System~~ (FIXED)

~~During our reference implementation work, we discovered a fundamental issue in the Node API subscription system. The core system needs to be fixed rather than continuing to use workarounds.~~

~~**For details, see:** `event_handling_core_fix.md`~~

~~This issue affects the final implementation of the `#[subscribe]` macro and requires changes to the core Node API.~~

**Update:** This issue has been fixed! The core system now supports async-only callbacks for subscriptions. See `rust-docs/specs/completed/event_handling_core_fix.md` for details on the implemented solution.

## New Issue: Auto-Registration System Needed

During our implementation work, we identified a need for an auto-registration system. Currently, each action and subscription generates its own individual registration method, but these methods need to be called from central registration methods:

1. The service's `register_actions` method needs to call each individual `register_function_name` method generated by the action macro
2. The service's `register_subscriptions` method needs to call each individual `register_function_name_subscription` method generated by the subscribe macro

This requires a mechanism for macros to communicate with each other about what methods have been generated.

## Background and Lessons Learned

After several attempts to fix the macro implementation in the codebase, we've identified core issues that require a completely different approach:

1. **Circular Implementation Problems**:
   - Previous attempts modified the macro implementation to match test expectations
   - This led to hardcoded mock behaviors and test-specific logic in production code
   - We kept adding special cases to make tests pass rather than implementing correct macro behavior

2. **Design Mismatch**:
   - The existing macro tests expect specific implementation details that may not be ideal
   - Tests are coupled to implementation rather than behavior
   - This creates brittleness where any refactoring breaks tests, even if behavior is preserved

3. **Fundamental Implementation Flaws**:
   - Current macros contain test-specific behavior (like mock responses)
   - The macros try to do runtime reflection, which is limited in Rust
   - They mix concerns between code generation and test verification

## Implementation Strategy: Fix Fundamentals First

Our approach:

1. âœ… Fix the core Node API event handling system (completed)
2. âœ… Complete the macro implementation based on the reference implementation (completed)
3. ðŸ”„ Implement the auto-registration system to connect registration methods (in progress)
4. â¬œ Create new tests that verify behavior, not implementation details

### Reference Implementation (COMPLETED)

We have successfully completed a working reference implementation in `rust-macros-tests/tests/string_service.rs`. This implementation:
- Handles ValueType parameters correctly
- Implements both direct value and map-based parameters 
- Successfully handles service events through subscriptions (with current workaround)
- Works with the Node API in end-to-end tests
- Provides a template for what the macros should generate

### Macro Development Tasks

1. âœ… Create macros that generate code matching the reference implementation
2. âœ… Focus on clean, minimal code generation without special cases
3. ðŸ”„ Ensure macros produce exactly the same code as the manually written version (in progress)
4. ðŸ”„ Implement auto-registration system to connect all registration methods

### Auto-Registration System Design

We need a mechanism for macros to share information about generated methods. Options include:

1. **Compile-time Registry**: Use a shared data structure to track all methods with `#[action]` and `#[subscribe]` attributes
2. **Code Generation Approach**: Generate code that leverages Rust's type system to collect all registration methods
3. **Procedural Macro Coordination**: Modify all macros to work together and share information

### Test Development Tasks

1. â¬œ Remove all existing macro tests to avoid old constraints
2. â¬œ Create new tests that verify macro behavior, not implementation details
3. â¬œ Focus on end-to-end testing with the Node API
4. â¬œ Demonstrate how services should be used in real-world scenarios

## Implementation Requirements

Based on our reference implementation, the macros should generate code that follows these patterns:

### Service Macro Requirements

The `#[service]` macro should generate:

1. âœ… A proper implementation of the `AbstractService` trait with methods for:
   - âœ… `name()`, `path()`, `description()`, `version()`, `state()`
   - âœ… `actions()` - Returning a list of registered actions
   - âœ… `init()` - Setting up subscription handlers
   - âœ… `start()` and `stop()` - Service lifecycle management
   - âœ… `handle_request()` - Request handling and dispatch

2. âœ… A request dispatch system that:
   - âœ… Maps incoming requests to the appropriate handler based on the action name
   - âœ… Provides clear error messages when an action is not found
   - âœ… Uses a registry of action handlers

3. âœ… A cloneable service structure that works with async event handlers

4. ðŸ”„ Auto-registration methods:
   - ðŸ”„ `register_actions` - Calls all individual action registration methods
   - ðŸ”„ `register_subscriptions` - Calls all individual subscription registration methods

### Action Macro Requirements

The `#[action]` macro should:

1. âœ… Register an action handler in the service's action registry
2. âœ… Generate parameter extraction code for both:
   - âœ… Direct string/numeric parameters (`request.data` as `ValueType::String` or `ValueType::Number`)
   - âœ… Map parameters (`request.data` as `ValueType::Map`)
3. ðŸ”„ Properly handle `Option<ValueType>` for the data field
4. âœ… Wrap the returned value in a `ServiceResponse` with appropriate status and message
5. ðŸ”„ Register itself with the auto-registration system

### Subscribe Macro Requirements

The `#[subscribe]` macro should:

1. âœ… Generate a subscription registration method that runs during service initialization
2. âœ… Create a callback that extracts parameters from the event payload
3. âœ… Handle different payload formats (direct values vs maps)
4. âœ… Implement proper async event handlers with error handling
5. âœ… Ensure thread safety for event handlers through proper use of Arc and Clone
6. âœ… Use the new async subscription API (core system now fixed)
7. ðŸ”„ Register itself with the auto-registration system

## Testing Approach

1. Create focused unit tests for each macro individually
2. Develop integration tests that show all macros working together
3. Test with the Node API to ensure end-to-end functionality
4. Verify both value-based and map-based parameter handling

## Next Steps

1. âœ… Fix the core Node API event handling system (COMPLETED)
2. âœ… Enhance the macro implementation (COMPLETED)
   - âœ… Add parameter extraction logic to action handlers
   - âœ… Add ActionRegistry field to service struct
   - âœ… Improve payload handling in subscribe
3. ðŸ”„ Create auto-registration system for actions and subscriptions (IN PROGRESS)
   - Implement a shared registry for tracking all action and subscription methods
   - Modify service macro to generate code that calls all registration methods
   - Ensure proper registration of all handlers
4. â¬œ Create comprehensive tests
5. â¬œ Document the new approach and patterns 